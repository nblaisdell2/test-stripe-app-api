version: 0.2

phases:
  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $awsRegion | docker login --username AWS --password-stdin $awsAccountID.dkr.ecr.$awsRegion.amazonaws.com
  build:
    commands:
      - echo "Building the Docker image..."
      - docker build -t $dockerContainerName:latest .
      - docker tag $dockerContainerName:latest $awsAccountID.dkr.ecr.$awsRegion.amazonaws.com/$dockerContainerName:latest
  post_build:
    commands:
      - echo "Pushing container to ECR..."
      - docker push $awsAccountID.dkr.ecr.$awsRegion.amazonaws.com/$dockerContainerName:latest
      - echo "Creating new Lambda version..."
      - aws lambda update-function-code --region $awsRegion --function-name $dockerContainerName --image-uri $awsAccountID.dkr.ecr.$awsRegion.amazonaws.com/$dockerContainerName:latest
      - sleep 20
      - 'aws lambda update-function-configuration --function-name $dockerContainerName --environment ''{ "Variables": { "DB_HOST": "sql-server-db-1.ctm8otgitadb.us-east-1.rds.amazonaws.com", "DB_USER": "admin", "DB_PWD": "FG2xnEcDpC8kNLbAfLUw", "DB_NAME": "TestStripe", "BASE_CLIENT_URL": "https://teststripe.testapisite.net", "STRIPE_SUBSCRIPTION_PRODUCT_ID": "prod_OMN3dLFYDmR0Dq", "STRIPE_WEBHOOK_SECRET": "whsec_p4wYQFgPH1ZXDh23OQgMiVIc7C7Dv5WH", "STRIPE_API_SECRET_KEY": "sk_test_51NZauGIJJf7l1lt3DtKm3TRFuihSjuz6li4w3zKfrD7ELZsI9OIrdBE36uQY9A6kBivd46dhEnWUZT8cX9XVukiJ00rgNOJW03", "SOMETHING_ELSE": ''$dockerContainerName'' } }'''
      - sleep 10
      - aws lambda publish-version --function-name $dockerContainerName
      - echo "Deploying new Lambda function version"
      - CURR_VERSION=$(aws lambda get-function --function-name $dockerContainerName:latest | jq -r .Configuration.Version)
      - NEXT_VERSION=$((CURR_VERSION + 1))
      - 'aws deploy create-deployment --application-name $dockerContainerName-deploy --deployment-config-name CodeDeployDefault.LambdaAllAtOnce --deployment-group-name $dockerContainerName-deploy-group --region $awsRegion --revision ''{"revisionType": "AppSpecContent", "appSpecContent": {"content": "{version: 0, Resources: [{myLambdaFunction: {Type: ''AWS::Lambda::Function'', Properties: {Name: ''$dockerContainerName'', CurrentVersion: ''$CURR_VERSION'', TargetVersion: ''$NEXT_VERSION'', Alias: latest}}}]}"}}'''
